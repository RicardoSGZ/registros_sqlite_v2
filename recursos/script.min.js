function conversor(e){for(var t=e.split(""),n=0;n<t.length;n++)"á"==t[n]?t[n]="a":"é"==t[n]?t[n]="e":"í"==t[n]?t[n]="i":"ó"==t[n]?t[n]="o":"ú"==t[n]?t[n]="u":"ñ"==t[n]?t[n]="n":" "==t[n]&&(t[n]="_");return t.join("").toLowerCase()}function numero(){for(var e=db.prepare("SELECT count(*) AS num FROM tabla");e.step();)var t=e.getAsObject();var n=document.getElementsByTagName("tr").length-1;document.getElementById("numero").innerHTML="Número de registros seleccionados: "+n+" ("+(n/t.num*100).toFixed(2)+"%)",e.free()}function ejecucion_sentencia(e){document.getElementById("tabla").innerHTML="";for(var t="SELECT * FROM categorias",n=db.prepare(t),a=document.createElement("table"),d=document.createElement("tr");n.step();){var r=n.getAsObject(),i=document.createElement("th");i.setAttribute("onclick","ordenar('"+r.db_name+"');"),i.innerHTML=r.full_name,d.appendChild(i)}a.appendChild(d);for(var l=db.prepare(e);l.step();){var o=l.getAsObject();d=document.createElement("tr");for(var c=db.prepare(t),m=0;c.step();){r=c.getAsObject();if(0==m){(s=document.createElement("td")).innerHTML=o[r.db_name]+"<div id='iconos'><img onclick='borrar("+o[r.db_name]+");' class='borrar' src='recursos/imagenes/del.png' alt='Borrar'/></div>",d.appendChild(s)}else{var s=document.createElement("td");s.setAttribute("onclick","editar("+o.id+");");var u=document.createElement("div");u.innerHTML=o[r.db_name],s.appendChild(u),d.appendChild(s)}m++}a.appendChild(d)}document.getElementById("tabla").appendChild(a),numero()}function tabla_inicial(){var e="SELECT * ";ejecucion_sentencia(e+="FROM tabla")}function borrar(e){if(1==confirm("¿Quiere eliminar el registro nº "+e+"?")){var t="DELETE FROM tabla WHERE id = "+e;db.run(t);alert("Se ha eliminado el registro nº "+e+".");var n=db.export(),a=new Blob([n],{type:"application/octet-stream"}),d=window.URL.createObjectURL(a),r=document.createElement("a");r.href=d,r.style.display="none",r.setAttribute("id","dld"),r.setAttribute("download","registros.db"),document.getElementById("tabla").after(r),r.click(),window.URL.revokeObjectURL(d)}else alert("No se ha eliminado el registro")}function editar(e){location.assign("#up"),document.getElementById("add_mod_section").innerHTML="",document.getElementById("tabla").style.display="none",document.getElementById("numero").style.display="none",document.getElementById("add_mod_section").style.display="block";var t=db.prepare("SELECT * FROM categorias WHERE db_name != 'id'"),n=document.createElement("div");n.setAttribute("id","div_campos");var a=document.createElement("p");for(a.setAttribute("id","campo_id"),n.appendChild(a);t.step();){if("added_collection"==(p=t.getAsObject()).db_name||regex_col_fecha.test(p.db_name)){var d=document.createElement("label");d.setAttribute("for",p.db_name),d.innerHTML=p.full_name,n.appendChild(d);var r=document.createElement("input");r.setAttribute("type","date"),r.setAttribute("id",p.db_name),r.setAttribute("class","fecha"),n.appendChild(r)}else if(regex_col_hora.test(p.db_name)){var i=document.createElement("label");i.setAttribute("for",p.db_name),i.innerHTML=p.full_name,n.appendChild(i);var l=document.createElement("input");l.setAttribute("type","time"),l.setAttribute("id",p.db_name),l.setAttribute("class","hora"),n.appendChild(l)}else{var o=document.createElement("label");o.setAttribute("for",p.db_name),o.innerHTML=p.full_name,n.appendChild(o);var c=document.createElement("textarea");c.setAttribute("id",p.db_name),c.setAttribute("placeholder",p.full_name),n.appendChild(c)}}var m=document.createElement("button");m.innerHTML="MODIFICAR",n.appendChild(m),document.getElementById("add_mod_section").appendChild(n);for(var s="SELECT * FROM tabla WHERE id = "+e,u=db.prepare(s),b=db.prepare("SELECT * FROM categorias where db_name != 'id'");u.step();){for(var E=u.getAsObject();b.step();){var p=b.getAsObject();document.getElementById(p.db_name).value=E[p.db_name],document.getElementById("campo_id").innerHTML="ID: "+E.id}var g=document.createElement("div");if(g.setAttribute("id","div_imagenes"),""!=E.img_pr){var _=document.createElement("img"),v=document.createElement("a");_.setAttribute("src",E.img_pr),v.setAttribute("href",E.img_pr),v.setAttribute("target","_blank"),_.setAttribute("id","img_principal"),v.appendChild(_),g.appendChild(v)}if(""!=E.img_sc1){var y=document.createElement("img"),f=document.createElement("a");y.setAttribute("src",E.img_sc1),f.setAttribute("href",E.img_sc1),f.setAttribute("target","_blank"),y.setAttribute("id","img_sc1"),f.appendChild(y),g.appendChild(f)}if(""!=E.img_sc2){var h=document.createElement("img"),A=document.createElement("a");h.setAttribute("src",E.img_sc2),A.setAttribute("href",E.img_sc2),A.setAttribute("target","_blank"),h.setAttribute("id","img_sc2"),A.appendChild(h),g.appendChild(A)}if(""!=E.img_sc3){var I=document.createElement("img"),L=document.createElement("a");I.setAttribute("src",E.img_sc3),L.setAttribute("href",E.img_sc3),L.setAttribute("target","_blank"),I.setAttribute("id","img_sc3"),L.appendChild(I),g.appendChild(L)}document.getElementById("add_mod_section").appendChild(g)}document.getElementById("add_mod_section").getElementsByTagName("button")[0].addEventListener("click",function(){document.getElementById("add_mod_section").getElementsByTagName("textarea");if(1==confirm("¿Quiere modificar el registro nº "+e+"?")){for(var t="UPDATE tabla SET ",n=db.prepare("SELECT * FROM categorias where db_name != 'id'");n.step();){var a=n.getAsObject();t+="'"+a.db_name+"'='"+document.getElementById(a.db_name).value+"', "}t=(t=t.substr(0,t.length-2))+" WHERE id="+e;db.run(t);alert("Se ha actualizado el registro nº "+e+".");var d=db.export(),r=new Blob([d],{type:"application/octet-stream"}),i=window.URL.createObjectURL(r),l=document.createElement("a");l.href=i,l.style.display="none",l.setAttribute("id","dld"),l.setAttribute("download","registros.db"),document.getElementById("add_mod_section").after(l),l.click(),window.URL.revokeObjectURL(i)}else alert("No se ha actualizado el registro")})}function ordenar(e){var t="SELECT * ";t+="FROM tabla";var n=document.getElementById("busq").value;if(""!=n){var d=db.prepare("SELECT * FROM categorias"),r=0;for(t+=" WHERE ";d.step();){var i=d.getAsObject();t+=0==r?i.db_name+" LIKE '%"+n+"%'":" OR "+i.db_name+" LIKE '%"+n+"%'",r++}}t+=" ORDER BY "+e,a%2!=0&&(t+=" DESC"),ejecucion_sentencia(t),a++}document.getElementById("btn_createtable").addEventListener("click",function(){document.getElementById("intro").innerHTML="";var e=document.createElement("div");e.setAttribute("id","cat_crea");for(a=0;a<10;a++){var t=document.createElement("input");t.setAttribute("type","text"),t.setAttribute("id",a),t.setAttribute("class","cr_field"),t.setAttribute("placeholder","Nombre de la categoría"),e.appendChild(t),document.getElementById("intro").appendChild(e)}var n=document.createElement("div");n.setAttribute("id","tipos_crea");for(var a=0;a<10;a++){var d=document.createElement("select");d.setAttribute("id",a+"_tipo");var r=document.createElement("option");r.innerHTML="Texto";var i=document.createElement("option");i.innerHTML="Número",d.appendChild(r),d.appendChild(i),n.appendChild(d),document.getElementById("intro").appendChild(n)}var l=document.createElement("button");l.setAttribute("id","btn_createtable2"),l.innerHTML="CREAR TABLA",document.getElementById("intro").appendChild(l),document.getElementById("btn_createtable2").addEventListener("click",function(){var e,t,n=new SQL.Database,a=document.getElementsByClassName("cr_field"),d=document.getElementsByTagName("select");n.run("CREATE TABLE IF NOT EXISTS 'categorias' ('full_name' varchar(100), 'db_name' varchar(100))");var r="INSERT INTO categorias ('full_name', 'db_name') VALUES ('ID', 'id')";n.run(r);var i="CREATE TABLE IF NOT EXISTS 'tabla'";i+=" ('id' integer PRIMARY KEY, '"+e+"' "+t;for(var l=0;l<a.length;l++)""!=a[l].value&&(e=conversor(a[l].value),"Número"==d[l].value?t="integer":"Texto"==d[l].value&&(t="text"),i+=", '"+e+"' "+t,r="INSERT INTO categorias ('full_name', 'db_name') VALUES ('"+a[l].value+"', '"+e+"')",n.run(r));r="INSERT INTO categorias ('full_name', 'db_name') VALUES ('Imagen principal', 'img_pr')",n.run(r),r="INSERT INTO categorias ('full_name', 'db_name') VALUES ('Imagen 2', 'img_sc1')",n.run(r),r="INSERT INTO categorias ('full_name', 'db_name') VALUES ('Imagen 3', 'img_sc2')",n.run(r),i+=", 'img_pr' varchar(100), 'img_sc1' varchar(100), 'img_sc2' varchar(100), 'img_sc3' varchar(100))",n.run(i),alert("Tabla creada");var o=n.export(),c=new Blob([o],{type:"application/octet-stream"}),m=window.URL.createObjectURL(c),s=document.createElement("a");s.href=m,s.style.display="none",s.setAttribute("id","dld"),s.setAttribute("download","registros.db"),document.getElementById("intro").after(s),s.click(),window.URL.revokeObjectURL(m)})});var regex=new RegExp("[^A-Za-z0-9\\sáéíóúñ.]"),regex_col_fecha=new RegExp("(fecha|dia)w*"),regex_col_hora=new RegExp("(hora)w*");document.getElementById("busq").addEventListener("change",function(){var e=document.getElementById("busq").value;if(regex.test(e))alert("Carácter incorrecto");else{for(var t="SELECT * FROM tabla WHERE ",n=db.prepare("SELECT * FROM categorias"),a=0;n.step();){var d=n.getAsObject();t+=0==a?d.db_name+" LIKE '%"+e+"%'":" OR "+d.db_name+" LIKE '%"+e+"%'",a++}ejecucion_sentencia(t)}});var a=2,archivo_sel=document.getElementById("archivo");archivo_sel.addEventListener("change",function(){document.body.style.backgroundColor="white",document.getElementById("intro").style.display="none",document.getElementById("div_add").style.display="block",document.getElementById("btn_search").style.display="block",document.getElementById("div_refresh").style.display="block",document.getElementById("tabla").innerHTML="";var e=archivo_sel.files[0],t=new FileReader;t.onload=function(){var e=new Uint8Array(t.result);db=new SQL.Database(e),tabla_inicial(),document.getElementsByTagName("header")[0].addEventListener("click",function(){document.getElementById("add_mod_section").innerHTML="",document.getElementById("tabla").style.display="block",document.getElementById("numero").style.display="block",document.getElementById("add_mod_section").style.display="none"}),document.getElementById("div_refresh").addEventListener("click",function(){"block"==document.getElementById("add_mod_section").style.display&&(document.getElementById("add_mod_section").innerHTML="",document.getElementById("tabla").style.display="block",document.getElementById("numero").style.display="block",document.getElementById("add_mod_section").style.display="none"),document.getElementById("busq").value="",tabla_inicial()}),document.getElementById("div_add").addEventListener("click",function(){location.assign("#up"),document.getElementById("add_mod_section").innerHTML="",document.getElementById("tabla").style.display="none",document.getElementById("numero").style.display="none",document.getElementById("add_mod_section").style.display="block";for(var e=db.prepare("SELECT * FROM categorias WHERE db_name != 'id'");e.step();){var t=e.getAsObject();if("added_collection"==t.db_name||regex_col_fecha.test(t.db_name)){var n=document.createElement("label");n.setAttribute("for",t.db_name),n.innerHTML=t.full_name,document.getElementById("add_mod_section").appendChild(n);var a=document.createElement("input");a.setAttribute("type","date"),a.setAttribute("id",t.db_name),a.setAttribute("class","fecha"),document.getElementById("add_mod_section").appendChild(a)}else if(regex_col_hora.test(t.db_name)){var d=document.createElement("label");d.setAttribute("for",t.db_name),d.innerHTML=t.full_name,document.getElementById("add_mod_section").appendChild(d);var r=document.createElement("input");r.setAttribute("type","time"),r.setAttribute("id",t.db_name),r.setAttribute("class","hora"),document.getElementById("add_mod_section").appendChild(r)}else{var i=document.createElement("label");i.setAttribute("for",t.db_name),i.innerHTML=t.full_name,document.getElementById("add_mod_section").appendChild(i);var l=document.createElement("textarea");l.setAttribute("placeholder",t.full_name),l.setAttribute("id",t.db_name),document.getElementById("add_mod_section").appendChild(l)}}var o=document.createElement("button");o.innerHTML="AÑADIR",document.getElementById("add_mod_section").appendChild(o);document.getElementById("add_mod_section").getElementsByTagName("button")[0].addEventListener("click",function(){if(1==confirm("¿Quiere añadir el registro?")){for(var e="INSERT INTO tabla (",t="SELECT * FROM categorias where db_name != 'id'",n=db.prepare(t);n.step();){e+="'"+(a=n.getAsObject()).db_name+"', "}e=e.substr(0,e.length-2),e+=") VALUES (";for(var t="SELECT * FROM categorias where db_name != 'id'",n=db.prepare(t);n.step();){var a=n.getAsObject();e+="'"+document.getElementById(a.db_name).value+"', "}e=e.substr(0,e.length-2),e+=")",console.log(e);db.run(e);alert("Se ha añadido el registro");var d=db.export(),r=new Blob([d],{type:"application/octet-stream"}),i=window.URL.createObjectURL(r),l=document.createElement("a");l.href=i,l.style.display="none",l.setAttribute("id","dld"),l.setAttribute("download","registros.db"),document.getElementById("add_mod_section").after(l),l.click(),window.URL.revokeObjectURL(i)}else alert("No se ha añadido el registro")})})},t.readAsArrayBuffer(e)});